<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Backup & Restore - TickTick Orchestrator</title>
  <link rel="stylesheet" href="/css/style.css">
  <style>
    .backup-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .chaos-indicator {
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .chaos-indicator.chaos-detected {
      background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .chaos-indicator.chaos-ok {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
    }

    .chaos-level {
      font-size: 48px;
      font-weight: bold;
      margin: 10px 0;
    }

    .snapshot-list {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .snapshot-item {
      padding: 20px;
      border-bottom: 1px solid #e0e0e0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .snapshot-item:last-child {
      border-bottom: none;
    }

    .snapshot-info {
      flex: 1;
    }

    .snapshot-id {
      font-family: monospace;
      color: #666;
      font-size: 12px;
    }

    .snapshot-timestamp {
      font-weight: bold;
      margin: 5px 0;
    }

    .snapshot-reason {
      color: #4080FD;
      font-size: 14px;
    }

    .snapshot-stats {
      display: flex;
      gap: 20px;
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }

    .snapshot-actions {
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s;
    }

    .btn-restore {
      background: #4080FD;
      color: white;
    }

    .btn-restore:hover {
      background: #3070ED;
    }

    .btn-delete {
      background: #f5576c;
      color: white;
    }

    .btn-delete:hover {
      background: #e54758;
    }

    .btn-create {
      background: #00d084;
      color: white;
      padding: 15px 30px;
      font-size: 16px;
    }

    .btn-create:hover {
      background: #00c077;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .create-snapshot-section {
      background: white;
      border-radius: 8px;
      padding: 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-bottom: 30px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    .input-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }

    .input-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 14px;
    }

    /* Toast notifications compactes mode sombre */
    #toastContainer {
      position: fixed;
      top: 80px;
      right: 20px;
      z-index: 9999;
      display: flex;
      flex-direction: column;
      gap: 10px;
      max-width: 350px;
    }

    .toast-notification {
      padding: 12px 16px;
      border-radius: 6px;
      font-size: 14px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      display: flex;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease-out;
      color: white;
    }

    .toast-success {
      background: #1a4d2e;
      border-left: 4px solid #28a745;
    }

    .toast-error {
      background: #4d1a1a;
      border-left: 4px solid #dc3545;
    }

    .toast-warning {
      background: #4d3d1a;
      border-left: 4px solid #ffc107;
    }

    @keyframes slideIn {
      from { transform: translateX(400px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes slideOut {
      from { transform: translateX(0); opacity: 1; }
      to { transform: translateX(400px); opacity: 0; }
    }
  </style>
</head>
<body>
  <div class="backup-container">
    <h1>üõ°Ô∏è Backup & Restore</h1>
    <p>Gestion des snapshots pour annuler le chaos de l'orchestrateur</p>

    <!-- Indicateur de chaos -->
    <div id="chaosIndicator" class="chaos-indicator">
      <div style="font-size: 14px; opacity: 0.9;">Niveau de chaos d√©tect√©</div>
      <div class="chaos-level" id="chaosLevel">--</div>
      <div id="chaosRecommendation">Analyse en cours...</div>
      <div id="chaosIssues" style="margin-top: 15px; font-size: 14px;"></div>
    </div>

    <!-- Cr√©er snapshot -->
    <div class="create-snapshot-section">
      <h2>üì∏ Cr√©er un nouveau snapshot</h2>
      <div class="input-group">
        <label for="snapshotReason">Raison du snapshot (optionnel)</label>
        <input type="text" id="snapshotReason" placeholder="Ex: avant_test_nouvelle_r√®gle">
      </div>
      <button class="btn btn-create" id="createSnapshotBtn">
        Cr√©er un snapshot maintenant
      </button>
    </div>

    <!-- Liste des snapshots -->
    <div class="snapshot-list">
      <div style="padding: 20px; border-bottom: 2px solid #4080FD;">
        <h2 style="margin: 0;">üì¶ Snapshots disponibles</h2>
      </div>
      <div id="snapshotList" class="loading">
        Chargement des snapshots...
      </div>
    </div>

    <div style="text-align: center; padding: 20px; color: #666;">
      <p>Les snapshots sont conserv√©s pendant 30 jours</p>
      <p><a href="/dashboard" style="color: #4080FD;">‚Üê Retour au dashboard</a></p>
    </div>
  </div>

  <script>
    const API_BASE = '/api/backup';

    // Pas besoin de v√©rifier le token c√¥t√© client
    // La route /backup est d√©j√† prot√©g√©e c√¥t√© serveur
    // Les cookies httpOnly sont envoy√©s automatiquement avec credentials: 'include'

    const headers = {
      'Content-Type': 'application/json'
    };

    // Afficher notification toast compacte
    function showAlert(message, type = 'success') {
      // Cr√©er container si n'existe pas
      let toastContainer = document.getElementById('toastContainer');
      if (!toastContainer) {
        toastContainer = document.createElement('div');
        toastContainer.id = 'toastContainer';
        document.body.appendChild(toastContainer);
      }

      const icons = {
        'success': '‚úì',
        'error': '‚úï',
        'warning': '‚ö†'
      };

      const toast = document.createElement('div');
      toast.className = `toast-notification toast-${type}`;
      toast.innerHTML = `
        <span style="font-size: 16px; font-weight: bold;">${icons[type] || '‚Ñπ'}</span>
        <span style="flex: 1;">${message}</span>
        <button onclick="this.parentElement.remove()" style="
          background: none;
          border: none;
          color: #fff;
          cursor: pointer;
          opacity: 0.7;
          font-size: 18px;
          padding: 0;
          width: 20px;
          height: 20px;
        ">√ó</button>
      `;

      toastContainer.appendChild(toast);

      setTimeout(() => {
        toast.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }

    // Charger niveau de chaos
    async function loadChaosLevel() {
      try {
        const response = await fetch(`${API_BASE}/chaos-check`, {
          headers,
          credentials: 'include'
        });
        const data = await response.json();

        if (data.success) {
          const chaos = data.chaos;
          const indicator = document.getElementById('chaosIndicator');
          const levelEl = document.getElementById('chaosLevel');
          const recommendationEl = document.getElementById('chaosRecommendation');
          const issuesEl = document.getElementById('chaosIssues');

          levelEl.textContent = `${chaos.level}/100`;
          recommendationEl.textContent = `üí° ${chaos.recommendation}`;

          issuesEl.innerHTML = `
            <div style="display: flex; gap: 20px; flex-wrap: wrap;">
              <div>üìä √âv√©nements totaux: <strong>${chaos.issues.totalEvents}</strong></div>
              <div>üåô √âv√©nements minuit: <strong>${chaos.issues.eventsAtMidnight}</strong></div>
              <div>‚ö†Ô∏è Chevauchements: <strong>${chaos.issues.overlappingEvents}</strong></div>
            </div>
          `;

          if (chaos.detected) {
            indicator.className = 'chaos-indicator chaos-detected';
          } else {
            indicator.className = 'chaos-indicator chaos-ok';
          }
        }
      } catch (error) {
        console.error('Erreur chargement chaos:', error);
      }
    }

    // Charger liste snapshots
    async function loadSnapshots() {
      try {
        const response = await fetch(`${API_BASE}/list`, {
          headers,
          credentials: 'include'
        });
        const data = await response.json();

        const listEl = document.getElementById('snapshotList');

        if (!data.success || data.snapshots.length === 0) {
          listEl.innerHTML = '<div class="empty-state">Aucun snapshot disponible</div>';
          return;
        }

        listEl.innerHTML = data.snapshots.map(snapshot => {
          const date = new Date(snapshot.timestamp);
          const dateStr = date.toLocaleString('fr-FR', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          return `
            <div class="snapshot-item">
              <div class="snapshot-info">
                <div class="snapshot-id">${snapshot.id}</div>
                <div class="snapshot-timestamp">üìÖ ${dateStr}</div>
                <div class="snapshot-reason">üè∑Ô∏è ${snapshot.reason}</div>
                <div class="snapshot-stats">
                  <span>üìä ${snapshot.calendarEventsCount} √©v√©nements</span>
                  <span>üìã ${snapshot.ticktickTasksCount} t√¢ches</span>
                </div>
              </div>
              <div class="snapshot-actions">
                <button class="btn btn-restore" onclick="restoreSnapshot('${snapshot.id}')">
                  ‚Ü©Ô∏è Restaurer
                </button>
                <button class="btn btn-delete" onclick="deleteSnapshot('${snapshot.id}')">
                  üóëÔ∏è Supprimer
                </button>
              </div>
            </div>
          `;
        }).join('');

      } catch (error) {
        console.error('Erreur chargement snapshots:', error);
        document.getElementById('snapshotList').innerHTML =
          '<div class="empty-state">Erreur lors du chargement</div>';
      }
    }

    // Cr√©er snapshot
    document.getElementById('createSnapshotBtn').addEventListener('click', async () => {
      const btn = document.getElementById('createSnapshotBtn');
      const reason = document.getElementById('snapshotReason').value || 'manual';

      btn.disabled = true;
      btn.textContent = 'Cr√©ation en cours...';

      try {
        const response = await fetch(`${API_BASE}/snapshot`, {
          method: 'POST',
          headers,
          credentials: 'include',
          body: JSON.stringify({ reason })
        });

        const data = await response.json();

        if (data.success) {
          showAlert(`‚úÖ Snapshot cr√©√©: ${data.snapshot.calendarEvents} √©v√©nements, ${data.snapshot.ticktickTasks} t√¢ches`, 'success');
          document.getElementById('snapshotReason').value = '';
          await loadSnapshots();
        } else {
          showAlert(`‚ùå Erreur: ${data.error}`, 'error');
        }
      } catch (error) {
        showAlert(`‚ùå Erreur: ${error.message}`, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Cr√©er un snapshot maintenant';
      }
    });

    // Restaurer snapshot
    async function restoreSnapshot(snapshotId) {
      if (!confirm(`‚ö†Ô∏è Confirmer la restauration depuis ${snapshotId}?\n\nCela va:\n- Cr√©er un snapshot de s√©curit√©\n- Supprimer les √©v√©nements/t√¢ches non pr√©sents dans le snapshot\n- Recr√©er les √©v√©nements/t√¢ches du snapshot`)) {
        return;
      }

      showAlert('üîÑ Restauration en cours...', 'warning');

      try {
        const response = await fetch(`${API_BASE}/restore/${snapshotId}`, {
          method: 'POST',
          headers,
          credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
          const cal = data.restored.calendar;
          const tick = data.restored.ticktick;
          showAlert(`‚úÖ Restauration r√©ussie!\n\nCalendar: ${cal.created} cr√©√©s, ${cal.deleted} supprim√©s\nTickTick: ${tick.created} cr√©√©s, ${tick.deleted} supprim√©s\n\nSnapshot s√©curit√©: ${data.preRestoreSnapshot}`, 'success');
          await loadSnapshots();
          await loadChaosLevel();
        } else {
          showAlert(`‚ùå Erreur: ${data.error}`, 'error');
        }
      } catch (error) {
        showAlert(`‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    // Supprimer snapshot
    async function deleteSnapshot(snapshotId) {
      if (!confirm(`Supprimer le snapshot ${snapshotId}?`)) {
        return;
      }

      try {
        const response = await fetch(`${API_BASE}/${snapshotId}`, {
          method: 'DELETE',
          headers,
          credentials: 'include'
        });

        const data = await response.json();

        if (data.success) {
          showAlert('‚úÖ Snapshot supprim√©', 'success');
          await loadSnapshots();
        } else {
          showAlert(`‚ùå Erreur: ${data.error}`, 'error');
        }
      } catch (error) {
        showAlert(`‚ùå Erreur: ${error.message}`, 'error');
      }
    }

    // Initialisation
    loadChaosLevel();
    loadSnapshots();

    // Rafra√Æchir toutes les 30 secondes
    setInterval(() => {
      loadChaosLevel();
      loadSnapshots();
    }, 30000);
  </script>
</body>
</html>
